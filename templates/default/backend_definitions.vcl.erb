import directors;

<% if node['role_proxy']['virtual_host'] %>
  <% node['role_proxy']['virtual_host'].each do |app_id, app| %> 
    <% app_backends = app['backends'] %>
    <% app_backends.each do |backend| %>
backend <%= backend['name'] %> {
  .host = "<%= backend['host'] %>";
  .port = "<%= backend['port'] %>";
      <% if backend['probe'] %>
  .probe = {
    .url = <%= backend['probe']['url'] || '"/"' %>;
    .timeout = <%= backend['probe']['timeout'] || "1s" %>;
    .interval = <%= backend['probe']['interval'] || "5s" %>;
    .window = <%= backend['probe']['window'] || "5" %>;
    .threshold = <%= backend['probe']['threshold'] || "3" %>;
  }
      <% end %>
}
    <% end %>
sub vcl_init {
    <% app_dir = "#{app_id}_dir" %>
    new <%= app_dir %> = directors.round_robin();
    <% app_backends.each do |backend| %>
    <%= app_dir %>.add_backend(<%= backend['name'] %>);
    <% end %>
}
  <% end %>
<% end %>
